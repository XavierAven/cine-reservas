<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Perfil de Usuario</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1, h2, h3 {
            color: #004aad;
        }
        button {
            background-color: #004aad;
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
        }
        button:hover {
            background-color: #00337a;
        }
        #reservas div {
            margin-bottom: 8px;
            background: white;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <h1>Perfil de Usuario</h1>
    <p><strong>Nombre:</strong> <span id="nombre"></span></p>
    <p><strong>Email:</strong> <span id="email"></span></p>

    <h2>Mis reservas</h2>
    <div id="reservas"></div>

    <p><a href="index.html#cartelera" style="color:#004aad;">⬅️ Volver a la cartelera</a></p>

    <script>
        async function cargarPerfil() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Debes iniciar sesión.");
                window.location.href = "index.html";
                return;
            }

            try {
                const response = await fetch("/profile/", {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Error al cargar perfil");

                const data = await response.json();

                document.getElementById("nombre").textContent = data.nombre;
                document.getElementById("email").textContent = data.email;

                const reservasDiv = document.getElementById("reservas");
                reservasDiv.innerHTML = "";

                if (data.reservas.length === 0) {
                    reservasDiv.innerHTML = "<p>No tienes reservas activas.</p>";
                } else {
                    data.reservas.forEach(r => {
                        const div = document.createElement("div");
                        div.innerHTML = `
                            <strong>${r.pelicula_titulo}</strong> - ${r.fecha} ${r.hora} Sala: ${r.sala} - Asientos: ${r.asientos}
                            <button onclick="cancelarReserva(${r.reserva_id})">Cancelar</button>
                        `;
                        reservasDiv.appendChild(div);
                    });
                }
            } catch (error) {
                alert(error.message);
            }
        }

        async function cancelarReserva(reservaId) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Debes iniciar sesión.");
                return;
            }

            if (!confirm("¿Seguro que quieres cancelar esta reserva?")) return;

            try {
                const response = await fetch(`/profile/cancelar/${reservaId}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Error al cancelar la reserva");

                alert("Reserva cancelada.");
                cargarPerfil();
            } catch (error) {
                alert(error.message);
            }
        }

        window.onload = cargarPerfil;
    </script>
</body>
</html>
